<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Iguana Catch: Miami Realism</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');

        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000;
            font-family: 'Bangers', cursive;
            touch-action: none; 
        }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            color: #FFD700; 
            text-shadow: 3px 3px 0px #000;
            z-index: 10;
        }

        h1 { font-size: 80px; margin: 0; letter-spacing: 2px; }
        h2 { font-size: 40px; color: white; margin-top: 5px; }
        
        .control-group { 
            margin: 20px; 
            background: rgba(255,255,255,0.2); 
            padding: 15px; 
            border-radius: 15px; 
            border: 2px solid white;
        }
        
        button {
            padding: 15px 40px;
            font-size: 30px;
            font-family: 'Bangers', cursive;
            background: #FF4500;
            color: white;
            border: 4px solid white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #8B0000;
        }
        button:active { transform: translateY(5px); box-shadow: 0 0 0 #8B0000; }

        canvas { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>IGUANA CATCH</h1>
        <h2>MIAMI FREEZE ALERT</h2>
        
        <div class="control-group">
            <label style="font-size: 24px; color: white;">Drop Speed: <span id="speedVal">5</span></label><br>
            <input type="range" id="speedInput" min="1" max="10" value="5" oninput="document.getElementById('speedVal').innerText = this.value">
        </div>
        <div class="control-group">
            <label style="font-size: 24px; color: white;">Music: </label>
            <input type="checkbox" id="musicToggle" checked>
        </div>
        
        <button onclick="startGame()">PLAY NOW</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiLayer = document.getElementById('ui-layer');

        // --- ASSET LOADER ---
        const assets = {
            bg: new Image(),
            idle: new Image(),
            walk1: new Image(),
            walk2: new Image(),
            walk3: new Image(),
            iguana: new Image()
        };

        // LOAD FILES
        assets.bg.src = 'miami.png'; 
        assets.idle.src = 'idle.png';
        assets.walk1.src = 'walk1.png';
        assets.walk2.src = 'walk2.png';
        assets.walk3.src = 'walk3.png';
        assets.iguana.src = 'iguana.png';

        // --- AUDIO ---
        const audio = {
            music: new Audio('music.wav'),
            splat: new Audio('splat.wav'),
            cheer: new Audio('cheer.wav')
        };
        audio.music.loop = true;
        audio.music.volume = 0.4;

        // --- GAME VARIABLES ---
        let gameRunning = false;
        let score = 0;
        let strikes = 0;
        const maxStrikes = 5;
        let baseSpeed = 5;
        let frameCount = 0;
        let canvasW, canvasH;
        let scaleFactor = 1; // To adapt the background to screen size
        let musicEnabled = true;

        // --- SPAWN POINTS ---
        // These are percentages (0.0 to 1.0) of the width/height of your image
        // where the tree leaves are. 
        // Based on 'miami.png':
        const TREE_LOCATIONS = [
            { x: 0.10, y: 0.25 }, // Leftmost tree
            { x: 0.30, y: 0.40 }, // Leaning tree
            { x: 0.50, y: 0.10 }, // Center tall tree
            { x: 0.75, y: 0.35 }, // Right cluster
            { x: 0.90, y: 0.20 }  // Far right
        ];

        // --- RESIZE LOGIC ---
        function resize() {
            canvasW = window.innerWidth;
            canvasH = window.innerHeight;
            canvas.width = canvasW;
            canvas.height = canvasH;
            
            // Calculate scale to make background cover the screen nicely
            // We want to fill height, and let width crop if needed, or vice versa
            if (assets.bg.complete) {
                // Determine scale based on keeping the bottom (ground) visible
                scaleFactor = canvasH / assets.bg.naturalHeight;
            }
            
            ctx.imageSmoothingEnabled = false; 
            
            if(!gameRunning) draw();
        }
        window.addEventListener('resize', resize);
        assets.bg.onload = resize;

        // --- OBJECTS ---
        let spawners = []; // Replacing 'trees' with invisible spawners
        let iguanas = [];
        let particles = []; // Leaves falling effect
        
        let player = {
            x: 0, y: 0, w: 120, h: 160, 
            speed: 12, facingRight: true, 
            animFrame: 0, state: 'idle' 
        };

        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        // --- LOGIC ---
        function initGame() {
            spawners = TREE_LOCATIONS.map(loc => ({
                xPct: loc.x,
                yPct: loc.y,
                shakeTimer: 0
            }));
            
            player.x = canvasW / 2;
            // Player stands near bottom of screen (adjust -100 if feet are too low)
            player.y = canvasH - 150; 
        }

        function startGame() {
            baseSpeed = parseInt(document.getElementById('speedInput').value) + 3;
            musicEnabled = document.getElementById('musicToggle').checked;
            
            if(musicEnabled) {
                audio.music.currentTime = 0;
                audio.music.play().catch(e => console.log("Audio play failed:", e));
            }

            score = 0;
            strikes = 0;
            iguanas = [];
            particles = [];
            initGame();
            
            gameRunning = true;
            uiLayer.classList.add('hidden');
            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameRunning = false;
            audio.music.pause();
            uiLayer.innerHTML = `
                <h1>GAME OVER</h1>
                <h2>Caught: ${score}</h2>
                <button onclick="location.reload()">TRY AGAIN</button>
            `;
            uiLayer.classList.remove('hidden');
        }

        function spawnParticles(x, y) {
            // Create 5 little green bits to simulate rustling leaves
            for(let i=0; i<5; i++) {
                particles.push({
                    x: x + (Math.random() * 40 - 20),
                    y: y + (Math.random() * 40 - 20),
                    vx: (Math.random() * 2 - 1),
                    vy: (Math.random() * 2),
                    life: 20,
                    color: Math.random() > 0.5 ? '#228B22' : '#32CD32'
                });
            }
        }

        function update() {
            frameCount++;

            // Player Movement
            player.state = 'idle';
            if (keys['ArrowLeft'] || keys['KeyA']) {
                player.x -= player.speed;
                player.facingRight = false;
                player.state = 'walk';
            }
            if (keys['ArrowRight'] || keys['KeyD']) {
                player.x += player.speed;
                player.facingRight = true;
                player.state = 'walk';
            }
            // Boundaries
            if (player.x < 0) player.x = 0;
            if (player.x > canvasW - player.w) player.x = canvasW - player.w;
            
            if (player.state === 'walk' && frameCount % 8 === 0) {
                player.animFrame++;
            }

            // Spawner Logic
            // The background image dimensions scaled to screen
            const bgW = assets.bg.naturalWidth * scaleFactor;
            // Center the image if it's wider than screen, or align left?
            // Let's assume align left for simplicity of coordinates
            
            spawners.forEach(spawn => {
                // Calculate Real Screen X/Y based on percentage
                // If background is being cropped or centered, we need to map this carefully.
                // For now, we map percentage to CANVAS width/height which is safest for gameplay.
                const screenX = spawn.xPct * canvasW;
                const screenY = spawn.yPct * canvasH;

                if (spawn.shakeTimer > 0) {
                    spawn.shakeTimer--;
                    
                    // Add particle effect while shaking
                    if (frameCount % 5 === 0) spawnParticles(screenX, screenY);

                    if (spawn.shakeTimer === 0) {
                        // Drop Iguana
                        iguanas.push({
                            x: screenX,
                            y: screenY,
                            w: 60, h: 90, 
                            vy: 0, active: true
                        });
                    }
                } else if (Math.random() < 0.005) {
                    spawn.shakeTimer = 80; // Start shaking
                }
            });

            // Particles Update
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                if(p.life <= 0) particles.splice(i, 1);
            }

            // Iguana Logic
            iguanas.forEach(iguana => {
                if (!iguana.active) return;
                iguana.vy += 0.2; 
                if(iguana.vy > baseSpeed) iguana.vy = baseSpeed;
                iguana.y += iguana.vy;

                // Collision
                if (
                    iguana.x < player.x + player.w - 30 &&
                    iguana.x + iguana.w > player.x + 30 &&
                    iguana.y + iguana.h > player.y + 40 && // Top of basket
                    iguana.y < player.y + 100
                ) {
                    score++;
                    iguana.active = false;
                    if(musicEnabled) { audio.cheer.currentTime = 0; audio.cheer.play(); }
                }
                else if (iguana.y > canvasH) {
                    iguana.active = false;
                    strikes++;
                    if(musicEnabled) { audio.splat.currentTime = 0; audio.splat.play(); }
                    if (strikes >= maxStrikes) gameOver();
                }
            });
        }

        function draw() {
            // 1. Draw Background (Cover Mode)
            if (assets.bg.complete) {
                // This draws the image to fill the height, and centers it horizontally
                const drawW = assets.bg.naturalWidth * scaleFactor;
                const drawH = assets.bg.naturalHeight * scaleFactor;
                const offsetX = (canvasW - drawW) / 2; // Center it
                
                ctx.drawImage(assets.bg, offsetX, 0, drawW, drawH);
            } else {
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvasW, canvasH);
            }

            // 2. Draw Warning Signs ("!")
            spawners.forEach(spawn => {
                if(spawn.shakeTimer > 0 && frameCount % 10 < 5) {
                    ctx.fillStyle = 'red'; 
                    ctx.font = 'bold 50px Arial';
                    ctx.fillText('!', (spawn.xPct * canvasW) - 10, (spawn.yPct * canvasH) - 50);
                }
            });

            // 3. Draw Particles (Leaves)
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 5, 5);
            });

            // 4. Iguanas
            iguanas.forEach(iguana => {
                if (!iguana.active) return;
                ctx.drawImage(assets.iguana, iguana.x, iguana.y, iguana.w, iguana.h);
            });

            // 5. Player
            ctx.save();
            let currentImg = assets.idle;
            if (player.state === 'walk') {
                const cycle = [assets.walk1, assets.walk2, assets.walk3, assets.walk2];
                currentImg = cycle[player.animFrame % 4];
            }

            if (!player.facingRight) {
                ctx.translate(player.x + player.w/2, player.y + player.h/2);
                ctx.scale(-1, 1);
                ctx.translate(-(player.x + player.w/2), -(player.y + player.h/2));
            }
            ctx.drawImage(currentImg, player.x, player.y, player.w, player.h);
            ctx.restore();

            // 6. HUD
            ctx.fillStyle = 'white'; 
            ctx.font = '30px Bangers'; 
            ctx.shadowColor = 'black'; 
            ctx.shadowBlur = 4;
            ctx.lineWidth = 3;
            ctx.strokeText(`FROZEN IGUANAS: ${score}`, 20, 40);
            ctx.fillText(`FROZEN IGUANAS: ${score}`, 20, 40);
            
            ctx.strokeText(`STRIKES: ${strikes}/${maxStrikes}`, 20, 80);
            ctx.fillText(`STRIKES: ${strikes}/${maxStrikes}`, 20, 80);
            ctx.shadowBlur = 0;
        }

        function gameLoop() {
            if (!gameRunning) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // Init
        resize();

    </script>
</body>
</html>